<?php
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Headers: access");
header("Access-Control-Allow-Methods: GET,POST");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require __DIR__ . '/classes/Database.php';
require __DIR__ . '/classes/JwtHandler.php';

$response['success'] = true;
try {
    $db_connection = new Database();
    $pdo = $db_connection->dbConnection();
    $target_dir = "uploads/";
    $target_file = $target_dir . basename($_FILES["file"]["name"]);
    $uploadOk = 1;
    $pdfFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
    $allowed_extensions = array('pdf');
    $jwt = new JwtHandler();
    if ($_FILES["file"]["size"] > 500000) {
        $response['success'] = false;
        $response['error'] = "File size must be less than 500kb";
    } else if (file_exists($target_file)) {
        $response['success'] = false;
        $response['error'] = "Please rename your resume and try again.";
    } else {
        move_uploaded_file($_FILES["file"]["tmp_name"], $target_file);
        $stmt = $pdo->prepare("insert into job_applications (job_sl,name,email,phone,education,year,message,
        resume_url) values (:job_sl,:name,:email,:phone,:education,:year,:message,
        :resume_url)");

        $stmt->execute(
            array(
                ":job_sl"=>$_POST['sl'],
                ":name"=>$_POST['name'],
                ":email"=>$_POST['email'],
                ":phone"=>$_POST['phone'],
                ":education"=>$_POST['education'],
                ":year"=>$_POST['year'],
                ":message"=>$_POST['message'],
                ":resume_url"=>$target_file
            )
            );
    }
} catch (\Error $e) {
    $response['success'] = false;
    $response["error"] = $e->getMessage();
}
echo json_encode($response);
